/**
 * COMPLETE PUPIL FEE DISPLAY FIXES
 * Replace loadFeeBalance() in pupil.js
 */

/**
 * FIXED: Load Fee Balance - Always Shows Data
 * Handles missing records, arrears, and all edge cases
 */
async function loadFeeBalance() {
    if (!currentPupilId) return;

    const feeSection = document.getElementById('fee-balance-section');
    if (!feeSection) return;

    // Show loading state
    feeSection.style.display = 'block';
    feeSection.innerHTML = `
        <div style="text-align:center; padding:var(--space-2xl);">
            <div class="spinner"></div>
            <p>Loading fee information...</p>
        </div>
    `;

    try {
        const settings = await window.getCurrentSettings();
        const session = settings.session;
        const currentTerm = settings.term;
        const encodedSession = session.replace(/\//g, '-');

        // Get current pupil data for class info
        const pupilDoc = await db.collection('pupils').doc(currentPupilId).get();
        if (!pupilDoc.exists) {
            throw new Error('Pupil profile not found');
        }
        
        const pupilData = pupilDoc.data();
        const classId = pupilData.class?.id;
        const className = pupilData.class?.name || 'Unknown';

        // Get payment record for CURRENT TERM
        const paymentDocId = `${currentPupilId}_${encodedSession}_${currentTerm}`;
        let paymentDoc = await db.collection('payments').doc(paymentDocId).get();

        let amountDue = 0;
        let arrears = 0;
        let totalPaid = 0;
        let balance = 0;
        let status = 'owing';
        let recordExists = paymentDoc.exists;

        // If record doesn't exist, try to create it automatically
        if (!recordExists && classId) {
            console.log('âš ï¸ Payment record missing, attempting auto-creation...');
            
            // Get fee structure
            const feeDocId = `${classId}_${encodedSession}`;
            const feeDoc = await db.collection('fee_structures').doc(feeDocId).get();
            
            if (feeDoc.exists) {
                const feeData = feeDoc.data();
                amountDue = Number(feeData.total) || 0;
                
                // Calculate arrears from previous session
                const previousSession = getPreviousSessionName(session);
                if (previousSession) {
                    arrears = await calculateSessionBalance(currentPupilId, previousSession);
                }
                
                // Create payment record
                await db.collection('payments').doc(paymentDocId).set({
                    pupilId: currentPupilId,
                    pupilName: pupilData.name || 'Unknown',
                    classId: classId,
                    className: className,
                    session: session,
                    term: currentTerm,
                    amountDue: amountDue,
                    arrears: arrears,
                    totalDue: amountDue + arrears,
                    totalPaid: 0,
                    balance: amountDue + arrears,
                    status: arrears > 0 ? 'owing_with_arrears' : 'owing',
                    lastPaymentDate: null,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    autoCreated: true
                });
                
                console.log('âœ… Auto-created payment record');
                
                // Reload the record we just created
                paymentDoc = await db.collection('payments').doc(paymentDocId).get();
                recordExists = true;
                
                balance = amountDue + arrears;
                status = arrears > 0 ? 'owing_with_arrears' : 'owing';
            }
        }

        // Extract data if record exists
        if (recordExists) {
            const data = paymentDoc.data();
            amountDue = Number(data.amountDue) || 0;
            arrears = Number(data.arrears) || 0;
            totalPaid = Number(data.totalPaid) || 0;
            balance = Number(data.balance) || 0;
            status = data.status || 'owing';
        }

        // If still no data, show appropriate message
        if (amountDue === 0 && !recordExists) {
            feeSection.innerHTML = `
                <div class="section-header">
                    <div class="section-icon" style="background: linear-gradient(135deg, #9e9e9e 0%, #757575 100%);">
                        <i data-lucide="info"></i>
                    </div>
                    <div class="section-title">
                        <h2>Fee Information</h2>
                        <p>No fee structure configured for ${className} yet</p>
                    </div>
                </div>
                <div style="text-align:center; padding:var(--space-2xl); color:var(--color-gray-600);">
                    <p>Fee details will appear here once configured by the school administration.</p>
                    <p style="margin-top:var(--space-md); font-size:var(--text-sm);">
                        If you believe this is an error, please contact the school office.
                    </p>
                </div>
            `;
            
            if (typeof lucide !== 'undefined') lucide.createIcons();
            return;
        }

        // Status colors and icons
        let statusColor = '#f44336';
        let statusText = 'Outstanding Balance';
        let statusIcon = 'alert-circle';

        if (balance <= 0) {
            statusColor = '#4CAF50';
            statusText = 'Fully Paid';
            statusIcon = 'check-circle';
        } else if (totalPaid > 0) {
            statusColor = '#ff9800';
            statusText = 'Partial Payment';
            statusIcon = 'clock';
        }

        // Arrears warning block
        const arrearsHTML = arrears > 0 ? `
            <div style="background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); color: white; padding: var(--space-xl); border-radius: var(--radius-lg); margin-bottom: var(--space-xl); box-shadow: 0 4px 20px rgba(220, 53, 69, 0.3);">
                <div style="display: flex; align-items: center; gap: var(--space-md); margin-bottom: var(--space-md);">
                    <i data-lucide="alert-circle" style="width: 32px; height: 32px;"></i>
                    <div>
                        <h3 style="margin: 0; color: white;">Outstanding Arrears</h3>
                        <p style="margin: var(--space-xs) 0 0; opacity: 0.9;">From Previous Session(s)</p>
                    </div>
                </div>
                <div style="font-size: var(--text-3xl); font-weight: 700; margin-bottom: var(--space-sm);">
                    â‚¦${arrears.toLocaleString()}
                </div>
                <p style="margin: 0; opacity: 0.9; font-size: var(--text-sm);">
                    This amount is being carried forward and must be paid along with current term fees.
                </p>
            </div>
        ` : '';

        const totalDue = amountDue + arrears;
        const percentPaid = totalDue > 0 ? Math.round((totalPaid / totalDue) * 100) : 0;

        // Render fee section
        feeSection.innerHTML = `
            <div class="section-header">
                <div class="section-icon" style="background: linear-gradient(135deg, ${statusColor} 0%, ${statusColor}dd 100%);">
                    <i data-lucide="${statusIcon}"></i>
                </div>
                <div class="section-title">
                    <h2>Fee Status - ${currentTerm}</h2>
                    <p style="color: ${statusColor}; font-weight: 600;">${session} â€¢ ${statusText}</p>
                </div>
            </div>

            ${arrearsHTML}

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--space-lg); margin-bottom: var(--space-xl);">
                ${arrears > 0 ? `
                <div style="text-align: center; padding: var(--space-xl); background: #fef2f2; border: 2px solid #dc3545; border-radius: var(--radius-lg);">
                    <div style="font-size: var(--text-xs); color: #991b1b; margin-bottom: var(--space-xs); font-weight: 600;">Arrears</div>
                    <div style="font-size: var(--text-3xl); font-weight: 700; color: #dc3545;">â‚¦${arrears.toLocaleString()}</div>
                </div>` : ''}

                <div style="text-align: center; padding: var(--space-xl); background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%); color: white; border-radius: var(--radius-lg); box-shadow: 0 4px 12px rgba(33, 150, 243, 0.3);">
                    <div style="font-size: var(--text-xs); opacity: 0.9; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: var(--space-xs);">Current Term Fee</div>
                    <div style="font-size: var(--text-3xl); font-weight: 700;">â‚¦${amountDue.toLocaleString()}</div>
                    <div style="font-size: var(--text-xs); opacity: 0.8; margin-top: var(--space-xs);">${currentTerm}</div>
                </div>

                <div style="text-align: center; padding: var(--space-xl); background: linear-gradient(135deg, #4CAF50 0%, #388E3C 100%); color: white; border-radius: var(--radius-lg); box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);">
                    <div style="font-size: var(--text-xs); opacity: 0.9; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: var(--space-xs);">Total Paid</div>
                    <div style="font-size: var(--text-3xl); font-weight: 700;">â‚¦${totalPaid.toLocaleString()}</div>
                    <div style="font-size: var(--text-xs); opacity: 0.8; margin-top: var(--space-xs);">
                        ${totalPaid > 0 ? percentPaid + '% collected' : 'No payments yet'}
                    </div>
                </div>

                <div style="text-align: center; padding: var(--space-xl); background: linear-gradient(135deg, ${statusColor} 0%, ${statusColor}dd 100%); color: white; border-radius: var(--radius-lg); box-shadow: 0 4px 12px rgba(${statusColor === '#4CAF50' ? '76, 175, 80' : '244, 67, 54'}, 0.3);">
                    <div style="font-size: var(--text-xs); opacity: 0.9; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: var(--space-xs);">Outstanding</div>
                    <div style="font-size: var(--text-3xl); font-weight: 700;">â‚¦${balance.toLocaleString()}</div>
                    <div style="font-size: var(--text-xs); opacity: 0.8; margin-top: var(--space-xs);">
                        ${balance > 0 ? 'Amount remaining' : 'All paid!'}
                    </div>
                </div>
            </div>

            <!-- Payment History -->
            <div style="background: white; padding: var(--space-xl); border-radius: var(--radius-lg); border: 1px solid #e2e8f0;">
                <h3 style="margin: 0 0 var(--space-lg); display: flex; align-items: center; gap: var(--space-sm);">
                    <i data-lucide="receipt" style="width: 20px; height: 20px;"></i>
                    Payment History (All Sessions)
                </h3>
                <div id="payment-history-list" style="display: grid; gap: var(--space-md);">
                    <div style="text-align:center; padding:var(--space-lg); color:var(--color-gray-600);">
                        <div class="spinner" style="margin: 0 auto var(--space-sm);"></div>
                        <p>Loading payment records...</p>
                    </div>
                </div>
            </div>

            <!-- Payment Instructions -->
            <div style="margin-top: var(--space-xl); padding: var(--space-lg); background: ${balance > 0 ? '#fef2f2' : '#f0fdf4'}; border: 2px solid ${balance > 0 ? '#dc3545' : '#4CAF50'}; border-radius: var(--radius-md);">
                <h4 style="margin: 0 0 var(--space-sm); color: ${balance > 0 ? '#991b1b' : '#065f46'}; display: flex; align-items: center; gap: var(--space-sm);">
                    <i data-lucide="${balance > 0 ? 'alert-triangle' : 'check-circle'}" style="width: 18px; height: 18px;"></i>
                    ${balance > 0 ? 'Payment Required' : 'Term Fees Paid'}
                </h4>
                <p style="margin: 0; font-size: var(--text-sm); color: ${balance > 0 ? '#7f1d1d' : '#14532d'}; line-height: 1.6;">
                    ${balance > 0 
                        ? `You have an outstanding balance of â‚¦${balance.toLocaleString()} for ${currentTerm}. Please visit the school office to make payment.`
                        : `All fees for ${currentTerm} have been paid in full. Thank you!`}
                </p>
            </div>
        `;

        if (typeof lucide !== 'undefined') lucide.createIcons();

        // Load payment history for pupil (all sessions)
        await loadAllPaymentHistory(currentPupilId);

    } catch (error) {
        console.error('Error loading fee balance:', error);
        feeSection.innerHTML = `
            <div style="text-align:center; padding:var(--space-2xl); color:var(--color-danger);">
                <i data-lucide="alert-triangle" style="width: 48px; height: 48px; margin: 0 auto var(--space-md);"></i>
                <p style="font-weight: 600; margin-bottom: var(--space-sm);">Unable to load fee information</p>
                <p style="font-size: var(--text-sm);">Error: ${error.message}</p>
                <button class="btn btn-primary" onclick="loadFeeBalance()" style="margin-top: var(--space-lg);">
                    ðŸ”„ Retry
                </button>
            </div>
        `;
        
        if (typeof lucide !== 'undefined') lucide.createIcons();
    }
}

/**
 * Helper: Get previous session name
 */
function getPreviousSessionName(currentSession) {
    const match = currentSession.match(/(\d{4})\/(\d{4})/);
    if (!match) return null;
    
    const startYear = parseInt(match[1]);
    const endYear = parseInt(match[2]);
    
    return `${startYear - 1}/${endYear - 1}`;
}

/**
 * Helper: Calculate total balance for entire session
 */
async function calculateSessionBalance(pupilId, session) {
    try {
        const paymentsSnap = await db.collection('payments')
            .where('pupilId', '==', pupilId)
            .where('session', '==', session)
            .get();
        
        let totalBalance = 0;
        
        paymentsSnap.forEach(doc => {
            const data = doc.data();
            totalBalance += Number(data.balance) || 0;
        });
        
        return totalBalance;
        
    } catch (error) {
        console.error('Error calculating session balance:', error);
        return 0;
    }
}

// Replace the existing loadFeeBalance function with this one
window.loadFeeBalance = loadFeeBalance;

console.log('âœ… Pupil fee display fixes loaded');