<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Payment Receipt - Fahmid School</title>
  <link rel="stylesheet" href="styles.css">
  
 <style>
  /* Print-optimized styles */
  @media print {
    body {
      margin: 0;
      padding: 10mm;
      font-size: 12pt;
    }
    
    .no-print {
      display: none !important;
    }
    
    .receipt-container {
      box-shadow: none !important;
      border: 1px solid #000 !important;
      padding: 12mm 10mm !important;
      max-width: none !important;
      width: 100% !important;
    }
    
    h1, h2 {
      margin: 0.4em 0 !important;
    }
  }

  .receipt-container {
    max-width: 650px;               /* ‚Üê narrower than 800px */
    margin: 1.5rem auto;
    padding: 1.2rem;                /* ‚Üê reduced from 2rem */
    background: white;
    border: 1px solid #ccc;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    font-family: 'Helvetica', Arial, sans-serif;
    font-size: 13px;                /* ‚Üê base size smaller */
  }

  .receipt-header {
    text-align: center;
    border-bottom: 2px solid #00B2FF;
    padding-bottom: 0.8rem;
    margin-bottom: 1.2rem;
  }

  .school-logo {
    width: 70px;                    /* ‚Üê smaller logo */
    height: 70px;
    margin: 0 auto 0.6rem;
  }

  .school-name {
    font-size: 1.35rem;             /* ‚Üê reduced from 1.8rem */
    font-weight: 700;
    color: #00B2FF;
    margin: 0.2rem 0;
    line-height: 1.1;
  }

  .school-address {
    color: #555;
    font-size: 0.9rem;
    margin: 0.3rem 0 0;
    line-height: 1.3;
  }

  .receipt-title {
    font-size: 1.25rem;             /* ‚Üê reduced from 1.5rem */
    font-weight: 700;
    text-align: center;
    margin: 1rem 0 0.8rem;
    color: #222;
  }

  .receipt-info {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0.6rem 1rem;               /* tighter */
    margin-bottom: 1.2rem;
    font-size: 0.95rem;
  }

  .info-label {
    font-weight: 600;
    color: #555;
    font-size: 0.82rem;
  }

  .info-value {
    color: #111;
    font-weight: 500;
  }

  .payment-details {
    background: #f9f9f9;
    padding: 1rem;                  /* reduced */
    border-radius: 6px;
    margin: 1.2rem 0;
    font-size: 0.98rem;
  }

  .payment-row {
    display: flex;
    justify-content: space-between;
    padding: 0.5rem 0;
    border-bottom: 1px dashed #ddd;
  }

  .payment-row:last-child {
    border-bottom: none;
    border-top: 2px solid #00B2FF;
    padding-top: 0.8rem;
    margin-top: 0.4rem;
    font-size: 1.15rem;             /* still stands out but not huge */
    font-weight: 700;
    color: #00B2FF;
  }

  .signature-section {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1.5rem;
    margin: 1.8rem 0 1.2rem;
  }

  .signature-line {
    border-top: 1px solid #333;
    padding-top: 1.8rem;
    text-align: center;
    font-size: 0.9rem;
  }

  .receipt-footer {
    margin-top: 1.5rem;
    padding-top: 1rem;
    border-top: 1px solid #ddd;
    text-align: center;
    color: #666;
    font-size: 0.82rem;
    line-height: 1.4;
  }

  .print-button {
    position: fixed;
    top: 15px;
    right: 15px;
    z-index: 1000;
  }
</style>
</head>

<body>
  <button class="btn btn-primary print-button no-print" onclick="window.print()">
    üñ®Ô∏è Print Receipt
  </button>
  
  <div class="receipt-container">
    <div class="receipt-header">
      <div class="school-logo">
        <img src="logo.png" alt="School Logo" style="width:100%; height:100%; object-fit:contain;">
      </div>
      <h1 class="school-name">FAHMID NURSERY & PRIMARY SCHOOL</h1>
      <p class="school-address">
        18 Shittu Street, Adura Bus Stop, Alagbado, Lagos State<br>
        Phone: +2348061427297 ‚Ä¢ Email: fahmidschool@gmail.com
      </p>
    </div>
    
    <h2 class="receipt-title">PAYMENT RECEIPT</h2>
    
    <div class="receipt-info">
      <div class="info-item">
        <div class="info-label">Receipt Number:</div>
        <div class="info-value" id="receipt-no">Loading...</div>
      </div>
      
      <div class="info-item">
        <div class="info-label">Date:</div>
        <div class="info-value" id="receipt-date">Loading...</div>
      </div>
      
      <div class="info-item">
        <div class="info-label">Pupil Name:</div>
        <div class="info-value" id="student-name">Loading...</div>
      </div>
      
      <div class="info-item">
        <div class="info-label">Class:</div>
        <div class="info-value" id="student-class">Loading...</div>
      </div>
      
      <div class="info-item">
        <div class="info-label">Session:</div>
        <div class="info-value" id="receipt-session">Loading...</div>
      </div>
      
      <div class="info-item">
        <div class="info-label">Term:</div>
        <div class="info-value" id="receipt-term">Loading...</div>
      </div>
    </div>
    
    <div class="payment-details">
      <div class="payment-row">
        <span>Amount Paid:</span>
        <strong id="amount-paid">‚Ç¶0.00</strong>
      </div>
      
      <div class="payment-row">
        <span>Payment Method:</span>
        <span id="payment-method">-</span>
      </div>
      
      <div class="payment-row" id="notes-row" style="display:none;">
        <span>Notes:</span>
        <span id="payment-notes">-</span>
      </div>
      
      <div class="payment-row">
        <span>Balance Remaining:</span>
        <strong id="balance-remaining">‚Ç¶0.00</strong>
      </div>
    </div>
    
    <div class="signature-section">
      <div>
        <div class="signature-line">Received By</div>
      </div>
      <div>
        <div class="signature-line">Parent/Guardian Signature</div>
      </div>
    </div>
    
    <div class="receipt-footer">
      <p><strong>Thank you for your payment!</strong></p>
      <p>This is an official receipt. Please keep it for your records.</p>
      <p style="margin-top:1rem; font-size:0.8rem;">
        Generated on <span id="generated-date"></span>
      </p>
    </div>
  </div>
  
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="firebase-init.js"></script>
<script src="finance.js"></script>

<script>
const urlParams = new URLSearchParams(window.location.search);
const receiptNo = urlParams.get('receipt');

if (!receiptNo) {
    alert('No receipt number provided');
    window.close();
}

async function loadReceiptData() {
    try {
        await new Promise((resolve, reject) => {
            const maxWait = 10000;
            const startTime = Date.now();

            const checkReady = setInterval(() => {
                if (typeof db !== 'undefined' && typeof auth !== 'undefined') {

                    if (auth.currentUser) {
                        clearInterval(checkReady);
                        resolve();
                        return;
                    }

                    auth.onAuthStateChanged(user => {
                        if (user) {
                            clearInterval(checkReady);
                            resolve();
                        } else if (Date.now() - startTime > maxWait) {
                            clearInterval(checkReady);
                            console.warn('‚ö†Ô∏è Proceeding without authentication (timeout)');
                            resolve();
                        }
                    });

                } else if (Date.now() - startTime > maxWait) {
                    clearInterval(checkReady);
                    reject(new Error('Firebase initialization timeout'));
                }
            }, 100);
        });

        console.log('‚úì Firebase ready, querying receipt...');

        // OPTION A FIX: Read receipt document directly
        const doc = await db.collection('payment_transactions').doc(receiptNo).get();

        if (!doc.exists) {
            alert('Receipt not found or you do not have permission to view it');
            console.error('Receipt query returned empty');
            return;
        }

        const data = doc.data();
        console.log('‚úì Receipt data loaded:', data.receiptNo);

        document.getElementById('receipt-no').textContent = data.receiptNo;
        document.getElementById('student-name').textContent = data.pupilName;
        document.getElementById('student-class').textContent = data.className;
        document.getElementById('receipt-session').textContent = data.session;
        document.getElementById('receipt-term').textContent = data.term;

        const date = data.paymentDate
            ? data.paymentDate.toDate().toLocaleDateString('en-GB', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
              })
            : 'N/A';

        document.getElementById('receipt-date').textContent = date;
        document.getElementById('amount-paid').textContent =
            `‚Ç¶${Number(data.amountPaid).toLocaleString()}`;
        document.getElementById('payment-method').textContent =
            data.paymentMethod || 'Cash';

        if (data.notes) {
            document.getElementById('payment-notes').textContent = data.notes;
            document.getElementById('notes-row').style.display = 'flex';
        }

        const encodedSession = data.session.replace(/\//g, '-');
        const paymentDocId = `${data.pupilId}_${encodedSession}_${data.term}`;

        const paymentDoc = await db.collection('payments').doc(paymentDocId).get();
        const balance = paymentDoc.exists ? (paymentDoc.data().balance || 0) : 0;

        document.getElementById('balance-remaining').textContent =
            `‚Ç¶${balance.toLocaleString()}`;

        document.getElementById('generated-date').textContent =
            new Date().toLocaleString('en-GB');

        console.log('‚úì Receipt loaded successfully, printing...');
        setTimeout(() => window.print(), 1000);

    } catch (error) {
        console.error('‚ùå Receipt error:', error);

        let errorMsg = 'Failed to load receipt.';

        if (error.code === 'permission-denied') {
            errorMsg += ' You do not have permission to view this receipt.';
        } else if (error.code === 'unavailable') {
            errorMsg += ' Cannot connect to server. Check your internet connection.';
        } else {
            errorMsg += ' ' + error.message;
        }

        alert(errorMsg);
    }
}

loadReceiptData();
</script>
</body>
</html>