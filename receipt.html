<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Payment Receipt - Fahmid School</title>
  <link rel="stylesheet" href="styles.css">
  
  <style>
    /* Print-optimized styles */
    @media print {
      body {
        margin: 0;
        padding: 20px;
      }
      
      .no-print {
        display: none !important;
      }
      
      .receipt-container {
        box-shadow: none !important;
        border: 2px solid #000 !important;
      }
    }
    
    .receipt-container {
      max-width: 800px;
      margin: 2rem auto;
      padding: 2rem;
      background: white;
      border: 1px solid #ddd;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .receipt-header {
      text-align: center;
      border-bottom: 3px solid #00B2FF;
      padding-bottom: 1.5rem;
      margin-bottom: 2rem;
    }
    
    .school-logo {
      width: 100px;
      height: 100px;
      margin: 0 auto 1rem;
    }
    
    .school-name {
      font-size: 1.8rem;
      font-weight: 700;
      color: #00B2FF;
      margin: 0;
    }
    
    .school-address {
      color: #666;
      margin: 0.5rem 0 0;
    }
    
    .receipt-title {
      font-size: 1.5rem;
      font-weight: 700;
      text-align: center;
      margin: 2rem 0 1rem;
      color: #333;
    }
    
    .receipt-info {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
      margin-bottom: 2rem;
    }
    
    .info-item {
      padding: 0.5rem;
    }
    
    .info-label {
      font-weight: 600;
      color: #666;
      font-size: 0.9rem;
    }
    
    .info-value {
      font-size: 1.1rem;
      color: #333;
      margin-top: 0.25rem;
    }
    
    .payment-details {
      background: #f8f9fa;
      padding: 1.5rem;
      border-radius: 8px;
      margin: 2rem 0;
    }
    
    .payment-row {
      display: flex;
      justify-content: space-between;
      padding: 0.75rem 0;
      border-bottom: 1px solid #ddd;
    }
    
    .payment-row:last-child {
      border-bottom: none;
      font-size: 1.3rem;
      font-weight: 700;
      color: #00B2FF;
      padding-top: 1rem;
      margin-top: 0.5rem;
      border-top: 2px solid #00B2FF;
    }
    
    .receipt-footer {
      margin-top: 3rem;
      padding-top: 2rem;
      border-top: 2px solid #ddd;
      text-align: center;
      color: #666;
      font-size: 0.9rem;
    }
    
    .signature-section {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 2rem;
      margin: 3rem 0 2rem;
    }
    
    .signature-line {
      border-top: 1px solid #333;
      padding-top: 0.5rem;
      text-align: center;
      margin-top: 3rem;
    }
    
    .print-button {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
    }
  </style>
</head>

<body>
  <!-- Print Button -->
  <button class="btn btn-primary print-button no-print" onclick="window.print()">
    üñ®Ô∏è Print Receipt
  </button>
  
  <div class="receipt-container">
    <!-- Header -->
    <div class="receipt-header">
      <div class="school-logo">
        <img src="logo.png" alt="School Logo" style="width:100%; height:100%; object-fit:contain;">
      </div>
      <h1 class="school-name">FAHMID NURSERY & PRIMARY SCHOOL</h1>
      <p class="school-address">
        18 Shittu Street, Adura Bus Stop, Alagbado, Lagos State<br>
        Phone: +2348061427297 ‚Ä¢ Email: fahmidschool@gmail.com
      </p>
    </div>
    
    <!-- Receipt Title -->
    <h2 class="receipt-title">PAYMENT RECEIPT</h2>
    
    <!-- Receipt Information -->
    <div class="receipt-info">
      <div class="info-item">
        <div class="info-label">Receipt Number:</div>
        <div class="info-value" id="receipt-no">Loading...</div>
      </div>
      
      <div class="info-item">
        <div class="info-label">Date:</div>
        <div class="info-value" id="receipt-date">Loading...</div>
      </div>
      
      <div class="info-item">
        <div class="info-label">Student Name:</div>
        <div class="info-value" id="student-name">Loading...</div>
      </div>
      
      <div class="info-item">
        <div class="info-label">Class:</div>
        <div class="info-value" id="student-class">Loading...</div>
      </div>
      
      <div class="info-item">
        <div class="info-label">Session:</div>
        <div class="info-value" id="receipt-session">Loading...</div>
      </div>
      
      <div class="info-item">
        <div class="info-label">Term:</div>
        <div class="info-value" id="receipt-term">Loading...</div>
      </div>
    </div>
    
    <!-- Payment Details -->
    <div class="payment-details">
      <div class="payment-row">
        <span>Amount Paid:</span>
        <strong id="amount-paid">‚Ç¶0.00</strong>
      </div>
      
      <div class="payment-row">
        <span>Payment Method:</span>
        <span id="payment-method">-</span>
      </div>
      
      <div class="payment-row" id="notes-row" style="display:none;">
        <span>Notes:</span>
        <span id="payment-notes">-</span>
      </div>
      
      <div class="payment-row">
        <span>Balance Remaining:</span>
        <strong id="balance-remaining">‚Ç¶0.00</strong>
      </div>
    </div>
    
    <!-- Signatures -->
    <div class="signature-section">
      <div>
        <div class="signature-line">Received By</div>
      </div>
      <div>
        <div class="signature-line">Parent/Guardian Signature</div>
      </div>
    </div>
    
    <!-- Footer -->
    <div class="receipt-footer">
      <p><strong>Thank you for your payment!</strong></p>
      <p>This is an official receipt. Please keep it for your records.</p>
      <p style="margin-top:1rem; font-size:0.8rem;">
        Generated on <span id="generated-date"></span>
      </p>
    </div>
  </div>
  
  <!-- Firebase and Receipt Script -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="firebase-init.js"></script>
  <script src="finance.js"></script>
  
<script>
    // Get receipt number from URL
    const urlParams = new URLSearchParams(window.location.search);
    const receiptNo = urlParams.get('receipt');
    
    console.log('üßæ Receipt page loaded');
    console.log('Receipt number from URL:', receiptNo);
    
    if (!receiptNo) {
        alert('No receipt number provided in URL');
        document.body.innerHTML = '<h2 style="text-align:center; color:red; margin-top:50px;">Error: No receipt number provided</h2>';
        window.close();
        return;
    }
    
    // Wait for Firebase to be ready
    function waitForFirebase() {
        return new Promise((resolve, reject) => {
            let attempts = 0;
            const maxAttempts = 50;
            
            const checkFirebase = setInterval(() => {
                attempts++;
                
                if (typeof firebase !== 'undefined' && typeof db !== 'undefined' && firebase.auth) {
                    clearInterval(checkFirebase);
                    console.log('‚úì Firebase initialized');
                    resolve();
                } else if (attempts >= maxAttempts) {
                    clearInterval(checkFirebase);
                    reject(new Error('Firebase failed to initialize after ' + maxAttempts + ' attempts'));
                }
            }, 100);
        });
    }
    
    // Wait for authentication
    function waitForAuth() {
        return new Promise((resolve, reject) => {
            console.log('‚è≥ Waiting for authentication...');
            
            const unsubscribe = firebase.auth().onAuthStateChanged(user => {
                unsubscribe();
                
                if (user) {
                    console.log('‚úì User authenticated:', user.email || user.uid);
                    resolve(user);
                } else {
                    console.error('‚ùå No user authenticated');
                    reject(new Error('No authenticated user found'));
                }
            });
            
            // Timeout after 12 seconds
            setTimeout(() => {
                unsubscribe();
                reject(new Error('Authentication check timed out after 12 seconds'));
            }, 12000);
        });
    }
    
    // Load receipt data
    async function loadReceiptData() {
        try {
            console.log('üîÑ Starting receipt load process...');
            
            await waitForFirebase();
            console.log('‚úì Firebase ready');
            
            const user = await waitForAuth();
            console.log('‚úì Authentication complete. User ID:', user.uid);
            
            console.log('üîç Querying transactions for receiptNo:', receiptNo);
            
            const transactionsSnap = await db.collection('transactions')
                .where('receiptNo', '==', receiptNo)
                .where('pupilId', '==', user.uid)           // ‚Üê Added: helps pass pupil ownership rules
                .limit(1)
                .get();
            
            console.log('Query completed. Documents found:', transactionsSnap.size);
            
            if (transactionsSnap.empty) {
                console.warn('‚ö†Ô∏è No matching transaction found for this receipt and user');
                alert('Receipt not found or you do not have permission to view it.\nReceipt: ' + receiptNo);
                document.body.innerHTML += '<h3 style="text-align:center; color:#d32f2f;">Receipt not found or access denied</h3>';
                return;
            }
            
            const receiptData = transactionsSnap.docs[0].data();
            console.log('‚úì Receipt data loaded successfully');
            
            // Populate receipt fields
            document.getElementById('receipt-no').textContent    = receiptData.receiptNo || 'N/A';
            document.getElementById('student-name').textContent  = receiptData.pupilName || 'N/A';
            document.getElementById('student-class').textContent = receiptData.className || 'N/A';
            
            const paymentDate = receiptData.paymentDate 
                ? receiptData.paymentDate.toDate().toLocaleDateString('en-GB', {
                      year: 'numeric', month: 'long', day: 'numeric'
                  })
                : 'N/A';
            document.getElementById('receipt-date').textContent = paymentDate;
            
            document.getElementById('receipt-session').textContent = receiptData.session || 'N/A';
            document.getElementById('receipt-term').textContent   = receiptData.term || 'N/A';
            
            const amountPaid = Number(receiptData.amountPaid) || 0;
            document.getElementById('amount-paid').textContent = `‚Ç¶${amountPaid.toLocaleString('en-NG')}`;
            
            document.getElementById('payment-method').textContent = receiptData.paymentMethod || 'Cash';
            
            if (receiptData.notes) {
                document.getElementById('payment-notes').textContent = receiptData.notes;
                document.getElementById('notes-row').style.display = 'flex';
            }
            
            // Fetch balance from payments collection
            const session = receiptData.session || '';
            const term = receiptData.term || '';
            const encodedSession = session.replace(/\//g, '-');
            const paymentRecordId = `${receiptData.pupilId}_${encodedSession}_${term}`;
            
            console.log('üîç Fetching payment record:', paymentRecordId);
            
            const paymentDoc = await db.collection('payments').doc(paymentRecordId).get();
            
            let balance = 0;
            if (paymentDoc.exists) {
                balance = Number(paymentDoc.data().balance) || 0;
                console.log('‚úì Balance loaded:', balance);
            } else {
                console.warn('‚ö†Ô∏è Payment summary record not found for ID:', paymentRecordId);
            }
            
            document.getElementById('balance-remaining').textContent = `‚Ç¶${balance.toLocaleString('en-NG')}`;
            
            // Set generation timestamp
            document.getElementById('generated-date').textContent = 
                new Date().toLocaleString('en-GB', { dateStyle: 'medium', timeStyle: 'short' });
            
            console.log('‚úÖ Receipt fully loaded ‚Äî initiating print in 1.5 seconds');
            
            // Auto-print after short delay (increased slightly for rendering safety)
            setTimeout(() => {
                window.print();
            }, 1500);
            
        } catch (error) {
            console.error('‚ùå RECEIPT LOAD FAILED:', error);
            console.error('Error code:', error.code);
            console.error('Error message:', error.message);
            
            let userFriendlyMsg = 'Failed to load receipt. ';
            
            if (error.code === 'permission-denied') {
                userFriendlyMsg += 'Permission denied. You may need to be logged in as an admin or the receipt owner.';
            } else if (error.message.includes('not authenticated') || error.message.includes('Authentication')) {
                userFriendlyMsg += 'Please log in to view this receipt.';
            } else if (error.message.includes('Firebase failed')) {
                userFriendlyMsg += 'Firebase connection issue. Please refresh the page.';
            } else {
                userFriendlyMsg += error.message;
            }
            
            alert(userFriendlyMsg);
            document.body.innerHTML += `<div style="text-align:center; color:#d32f2f; margin:40px 0;">
                <h3>Error Loading Receipt</h3>
                <p>${userFriendlyMsg}</p>
                <small>Error code: ${error.code || 'unknown'}</small>
            </div>`;
        }
    }
    
    // Start loading when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', loadReceiptData);
    } else {
        loadReceiptData();
    }
</script>
</body>
</html>
