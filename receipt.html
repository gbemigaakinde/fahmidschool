<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Payment Receipt - Fahmid School</title>
  <link rel="stylesheet" href="styles.css">
  
  <style>
    /* Print-optimized styles */
    @media print {
      body {
        margin: 0;
        padding: 20px;
      }
      
      .no-print {
        display: none !important;
      }
      
      .receipt-container {
        box-shadow: none !important;
        border: 2px solid #000 !important;
      }
    }
    
    .receipt-container {
      max-width: 800px;
      margin: 2rem auto;
      padding: 2rem;
      background: white;
      border: 1px solid #ddd;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .receipt-header {
      text-align: center;
      border-bottom: 3px solid #00B2FF;
      padding-bottom: 1.5rem;
      margin-bottom: 2rem;
    }
    
    .school-logo {
      width: 100px;
      height: 100px;
      margin: 0 auto 1rem;
    }
    
    .school-name {
      font-size: 1.8rem;
      font-weight: 700;
      color: #00B2FF;
      margin: 0;
    }
    
    .school-address {
      color: #666;
      margin: 0.5rem 0 0;
    }
    
    .receipt-title {
      font-size: 1.5rem;
      font-weight: 700;
      text-align: center;
      margin: 2rem 0 1rem;
      color: #333;
    }
    
    .receipt-info {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
      margin-bottom: 2rem;
    }
    
    .info-item {
      padding: 0.5rem;
    }
    
    .info-label {
      font-weight: 600;
      color: #666;
      font-size: 0.9rem;
    }
    
    .info-value {
      font-size: 1.1rem;
      color: #333;
      margin-top: 0.25rem;
    }
    
    .payment-details {
      background: #f8f9fa;
      padding: 1.5rem;
      border-radius: 8px;
      margin: 2rem 0;
    }
    
    .payment-row {
      display: flex;
      justify-content: space-between;
      padding: 0.75rem 0;
      border-bottom: 1px solid #ddd;
    }
    
    .payment-row:last-child {
      border-bottom: none;
      font-size: 1.3rem;
      font-weight: 700;
      color: #00B2FF;
      padding-top: 1rem;
      margin-top: 0.5rem;
      border-top: 2px solid #00B2FF;
    }
    
    .receipt-footer {
      margin-top: 3rem;
      padding-top: 2rem;
      border-top: 2px solid #ddd;
      text-align: center;
      color: #666;
      font-size: 0.9rem;
    }
    
    .signature-section {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 2rem;
      margin: 3rem 0 2rem;
    }
    
    .signature-line {
      border-top: 1px solid #333;
      padding-top: 0.5rem;
      text-align: center;
      margin-top: 3rem;
    }
    
    .print-button {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
    }
  </style>
</head>

<body>
  <!-- Print Button -->
  <button class="btn btn-primary print-button no-print" onclick="window.print()">
    üñ®Ô∏è Print Receipt
  </button>
  
  <div class="receipt-container">
    <!-- Header -->
    <div class="receipt-header">
      <div class="school-logo">
        <img src="logo.png" alt="School Logo" style="width:100%; height:100%; object-fit:contain;">
      </div>
      <h1 class="school-name">FAHMID NURSERY & PRIMARY SCHOOL</h1>
      <p class="school-address">
        18 Shittu Street, Adura Bus Stop, Alagbado, Lagos State<br>
        Phone: +2348061427297 ‚Ä¢ Email: fahmidschool@gmail.com
      </p>
    </div>
    
    <!-- Receipt Title -->
    <h2 class="receipt-title">PAYMENT RECEIPT</h2>
    
    <!-- Receipt Information -->
    <div class="receipt-info">
      <div class="info-item">
        <div class="info-label">Receipt Number:</div>
        <div class="info-value" id="receipt-no">Loading...</div>
      </div>
      
      <div class="info-item">
        <div class="info-label">Date:</div>
        <div class="info-value" id="receipt-date">Loading...</div>
      </div>
      
      <div class="info-item">
        <div class="info-label">Pupil Name:</div>
        <div class="info-value" id="student-name">Loading...</div>
      </div>
      
      <div class="info-item">
        <div class="info-label">Class:</div>
        <div class="info-value" id="student-class">Loading...</div>
      </div>
      
      <div class="info-item">
        <div class="info-label">Session:</div>
        <div class="info-value" id="receipt-session">Loading...</div>
      </div>
      
      <div class="info-item">
        <div class="info-label">Term:</div>
        <div class="info-value" id="receipt-term">Loading...</div>
      </div>
    </div>
    
    <!-- Payment Details -->
    <div class="payment-details">
      <div class="payment-row">
        <span>Amount Paid:</span>
        <strong id="amount-paid">‚Ç¶0.00</strong>
      </div>
      
      <div class="payment-row">
        <span>Payment Method:</span>
        <span id="payment-method">-</span>
      </div>
      
      <div class="payment-row" id="notes-row" style="display:none;">
        <span>Notes:</span>
        <span id="payment-notes">-</span>
      </div>
      
      <div class="payment-row">
        <span>Balance Remaining:</span>
        <strong id="balance-remaining">‚Ç¶0.00</strong>
      </div>
    </div>
    
    <!-- Signatures -->
    <div class="signature-section">
      <div>
        <div class="signature-line">Received By</div>
      </div>
      <div>
        <div class="signature-line">Parent/Guardian Signature</div>
      </div>
    </div>
    
    <!-- Footer -->
    <div class="receipt-footer">
      <p><strong>Thank you for your payment!</strong></p>
      <p>This is an official receipt. Please keep it for your records.</p>
      <p style="margin-top:1rem; font-size:0.8rem;">
        Generated on <span id="generated-date"></span>
      </p>
    </div>
  </div>
  
  <!-- Firebase and Receipt Script -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="firebase-init.js"></script>
  <script src="finance.js"></script>
  
<script>
const urlParams = new URLSearchParams(window.location.search);
const receiptNo = urlParams.get('receipt');

if (!receiptNo) {
    alert('No receipt number provided');
    window.close();
}

async function loadReceiptData() {
    try {
        // Wait for Firebase
        await new Promise(resolve => {
            const check = setInterval(() => {
                if (typeof db !== 'undefined') {
                    clearInterval(check);
                    resolve();
                }
            }, 100);
        });

        // Query transaction (NO pupilId filter - rules handle security)
        const snap = await db.collection('transactions')
            .where('receiptNo', '==', receiptNo)
            .limit(1)
            .get();

        if (snap.empty) {
            alert('Receipt not found');
            return;
        }

        const data = snap.docs[0].data();

        // Populate receipt
        document.getElementById('receipt-no').textContent = data.receiptNo;
        document.getElementById('student-name').textContent = data.pupilName;
        document.getElementById('student-class').textContent = data.className;
        document.getElementById('receipt-session').textContent = data.session;
        document.getElementById('receipt-term').textContent = data.term;

        const date = data.paymentDate 
            ? data.paymentDate.toDate().toLocaleDateString('en-GB', {
                year: 'numeric', month: 'long', day: 'numeric'
              })
            : 'N/A';
        document.getElementById('receipt-date').textContent = date;

        document.getElementById('amount-paid').textContent = 
            `‚Ç¶${Number(data.amountPaid).toLocaleString()}`;
        document.getElementById('payment-method').textContent = 
            data.paymentMethod || 'Cash';

        if (data.notes) {
            document.getElementById('payment-notes').textContent = data.notes;
            document.getElementById('notes-row').style.display = 'flex';
        }

        // Get balance (encoded session)
        const encodedSession = data.session.replace(/\//g, '-');
        const paymentDocId = `${data.pupilId}_${encodedSession}_${data.term}`;
        const paymentDoc = await db.collection('payments').doc(paymentDocId).get();

        const balance = paymentDoc.exists ? (paymentDoc.data().balance || 0) : 0;
        document.getElementById('balance-remaining').textContent = 
            `‚Ç¶${balance.toLocaleString()}`;

        document.getElementById('generated-date').textContent = 
            new Date().toLocaleString('en-GB');

        // Auto-print
        setTimeout(() => window.print(), 1000);

    } catch (error) {
        console.error('Receipt error:', error);
        alert('Failed to load receipt: ' + error.message);
    }
}

loadReceiptData();
</script>
</body>
</html>
