/**
 * COMPLETE FEE MANAGEMENT FIXES
 * Replace/add these functions in admin.js
 */

/* =====================================================
   FIX 1: ENABLE FEE STRUCTURE EDITING
===================================================== */

/**
 * Edit existing fee structure
 * ADD this function after saveFeeStructure()
 */
async function editFeeStructure(feeDocId) {
  try {
    const feeDoc = await db.collection('fee_structures').doc(feeDocId).get();
    
    if (!feeDoc.exists) {
      window.showToast?.('Fee structure not found', 'danger');
      return;
    }
    
    const data = feeDoc.data();
    
    // Populate form with existing data
    document.getElementById('fee-config-class').value = data.classId;
    document.getElementById('fee-tuition').value = data.fees?.tuition || 0;
    document.getElementById('fee-exam').value = data.fees?.exam_fee || 0;
    document.getElementById('fee-uniform').value = data.fees?.uniform || 0;
    document.getElementById('fee-books').value = data.fees?.books || 0;
    document.getElementById('fee-pta').value = data.fees?.pta || 0;
    document.getElementById('fee-other').value = data.fees?.other || 0;
    
    // Change button text and add data attribute
    const saveBtn = document.getElementById('save-fee-structure-btn');
    if (saveBtn) {
      saveBtn.textContent = '‚úèÔ∏è Update Fee Structure';
      saveBtn.dataset.editingId = feeDocId;
    }
    
    // Scroll to form
    document.getElementById('fee-config-class').scrollIntoView({ 
      behavior: 'smooth', 
      block: 'start' 
    });
    
    window.showToast?.(`Editing fee structure for ${data.className}`, 'info', 3000);
    
  } catch (error) {
    console.error('Error loading fee for edit:', error);
    window.showToast?.('Failed to load fee structure', 'danger');
  }
}

/**
 * REPLACE saveFeeStructure() with this version
 * Handles both create and update
 */
async function saveFeeStructure() {
  const classSelect = document.getElementById('fee-config-class');
  const classId = classSelect?.value;
  const className = classSelect?.selectedOptions[0]?.dataset.className;
  
  if (!classId) {
    window.showToast?.('Please select a class', 'warning');
    return;
  }
  
  const tuition = parseFloat(document.getElementById('fee-tuition')?.value) || 0;
  const examFee = parseFloat(document.getElementById('fee-exam')?.value) || 0;
  const uniform = parseFloat(document.getElementById('fee-uniform')?.value) || 0;
  const books = parseFloat(document.getElementById('fee-books')?.value) || 0;
  const pta = parseFloat(document.getElementById('fee-pta')?.value) || 0;
  const other = parseFloat(document.getElementById('fee-other')?.value) || 0;
  
  const feeBreakdown = {
    tuition: tuition,
    exam_fee: examFee,
    uniform: uniform,
    books: books,
    pta: pta,
    other: other
  };
  
  const total = Object.values(feeBreakdown).reduce((sum, val) => sum + val, 0);
  
  if (total <= 0) {
    window.showToast?.('Please enter at least one fee amount', 'warning');
    return;
  }
  
  const saveBtn = document.getElementById('save-fee-structure-btn');
  const isEditing = saveBtn?.dataset.editingId;
  
  if (saveBtn) {
    saveBtn.disabled = true;
    saveBtn.innerHTML = '<span class="btn-loading">Saving...</span>';
  }
  
  try {
    const settings = await window.getCurrentSettings();
    const session = settings.session;
    const encodedSession = session.replace(/\//g, '-');
    const feeDocId = isEditing || `${classId}_${encodedSession}`;
    
    // Check if creating new and already exists
    if (!isEditing) {
      const existingFeeDoc = await db.collection('fee_structures').doc(feeDocId).get();
      
      if (existingFeeDoc.exists) {
        const existingData = existingFeeDoc.data();
        const existingTotal = existingData.total || 0;
        
        const confirmation = confirm(
          `‚ö†Ô∏è FEE STRUCTURE ALREADY EXISTS\n\n` +
          `Class: ${className}\n` +
          `Session: ${session}\n\n` +
          `Current fee: ‚Ç¶${existingTotal.toLocaleString()} per term\n` +
          `New fee: ‚Ç¶${total.toLocaleString()} per term\n\n` +
          `This will update the existing fee structure.\n\n` +
          `Continue?`
        );
        
        if (!confirmation) {
          window.showToast?.('Operation cancelled', 'info');
          return;
        }
      }
    }
    
    // Archive old version if editing
    if (isEditing) {
      const oldDoc = await db.collection('fee_structures').doc(feeDocId).get();
      if (oldDoc.exists) {
        await db.collection('fee_structure_history').add({
          ...oldDoc.data(),
          archivedAt: firebase.firestore.FieldValue.serverTimestamp(),
          archivedBy: auth.currentUser.uid,
          reason: 'Fee structure updated by admin'
        });
      }
    }
    
    // Save/update fee structure
    await db.collection('fee_structures').doc(feeDocId).set({
      classId,
      className,
      session,
      fees: feeBreakdown,
      total: total,
      createdAt: isEditing ? (await db.collection('fee_structures').doc(feeDocId).get()).data()?.createdAt || firebase.firestore.FieldValue.serverTimestamp() : firebase.firestore.FieldValue.serverTimestamp(),
      updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
      lastModifiedBy: auth.currentUser.uid
    });

    window.showToast?.(
      `‚úì Fee structure ${isEditing ? 'updated' : 'saved'} for ${className}!\n\n` +
      `Per-term fee: ‚Ç¶${total.toLocaleString()}\n\n` +
      `${!isEditing ? 'Use "Generate Missing Records" to create payment records for pupils.' : 'Existing payment records are not affected.'}`,
      'success',
      8000
    );
    
    // Clear form
    document.getElementById('fee-config-class').value = '';
    ['fee-tuition', 'fee-exam', 'fee-uniform', 'fee-books', 'fee-pta', 'fee-other'].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.value = '';
    });
    
    // Reset button
    if (saveBtn) {
      saveBtn.textContent = 'üíæ Save Fee Structure';
      delete saveBtn.dataset.editingId;
    }
    
    await loadFeeStructures();
    
  } catch (error) {
    console.error('Error saving fee structure:', error);
    window.showToast?.('Failed to save fee structure: ' + error.message, 'danger');
  } finally {
    if (saveBtn) {
      saveBtn.disabled = false;
      saveBtn.innerHTML = isEditing ? '‚úèÔ∏è Update Fee Structure' : 'üíæ Save Fee Structure';
    }
  }
}

/**
 * REPLACE loadFeeStructures() to add Edit buttons
 */
async function loadFeeStructures() {
  const container = document.getElementById('fee-structures-list');
  if (!container) return;
  
  container.innerHTML = '<div style="text-align:center; padding:var(--space-lg);"><div class="spinner"></div><p>Loading fee structures...</p></div>';
  
  try {
    const settings = await window.getCurrentSettings();
    const session = settings.session;
    
    const snapshot = await db.collection('fee_structures')
      .where('session', '==', session)
      .get();
    
    if (snapshot.empty) {
      container.innerHTML = `
        <div style="text-align:center; padding:var(--space-2xl); color:var(--color-gray-600);">
          <p style="font-size:var(--text-lg); margin-bottom:var(--space-md);">üìã No Fee Structures Configured Yet</p>
          <p style="font-size:var(--text-sm);">Configure fees for your classes using the form above.</p>
        </div>
      `;
      return;
    }
    
    container.innerHTML = '';
    
    snapshot.forEach(doc => {
      const data = doc.data();
      
      const feeItems = Object.entries(data.fees || {})
        .map(([key, value]) => `
          <div style="display:flex; justify-content:space-between; padding:var(--space-xs) 0;">
            <span style="text-transform:capitalize;">${key.replace(/_/g, ' ')}:</span>
            <strong>‚Ç¶${parseFloat(value).toLocaleString()}</strong>
          </div>
        `).join('');
      
      const card = document.createElement('div');
      card.className = 'fee-structure-card';
      card.style.cssText = `
        background: white;
        border: 1px solid var(--color-gray-300);
        border-radius: var(--radius-md);
        padding: var(--space-lg);
        margin-bottom: var(--space-md);
      `;
      
      card.innerHTML = `
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:var(--space-md); padding-bottom:var(--space-md); border-bottom:1px solid var(--color-gray-200);">
          <div>
            <h3 style="margin:0; color:var(--color-primary);">${data.className}</h3>
            <p style="margin:var(--space-xs) 0 0; font-size:var(--text-sm); color:var(--color-gray-600);">
              ${data.session} ‚Ä¢ <strong>All Terms</strong>
            </p>
          </div>
          <div style="display:flex; gap:var(--space-sm);">
            <button class="btn-small btn-primary" onclick="editFeeStructure('${doc.id}')">
              ‚úèÔ∏è Edit
            </button>
            <button class="btn-small btn-danger" onclick="deleteFeeStructure('${doc.id}', '${data.className}')">
              Delete
            </button>
          </div>
        </div>
        
        <div style="margin-bottom:var(--space-md);">
          ${feeItems}
        </div>
        
        <div style="padding-top:var(--space-md); border-top:2px solid var(--color-primary); display:flex; justify-content:space-between; align-items:center;">
          <strong style="font-size:var(--text-lg);">Total per term:</strong>
          <strong style="font-size:var(--text-xl); color:var(--color-primary);">‚Ç¶${parseFloat(data.total).toLocaleString()}</strong>
        </div>
        
        <div style="margin-top:var(--space-md); padding:var(--space-sm); background:#e3f2fd; border-left:4px solid #2196F3; border-radius:var(--radius-sm); font-size:var(--text-sm);">
          ‚ÑπÔ∏è This fee applies to <strong>all terms</strong> in ${data.session} until you change it
        </div>
      `;
      
      container.appendChild(card);
    });
    
  } catch (error) {
    console.error('Error loading fee structures:', error);
    container.innerHTML = '<p style="text-align:center; color:var(--color-danger);">Error loading fee structures</p>';
  }
}

/* =====================================================
   FIX 2: AUTO-CREATE PAYMENT RECORDS ON TERM CHANGE
===================================================== */

/**
 * REPLACE migrateArrearsOnTermChange() in admin.js
 * This runs automatically when admin changes the term in settings
 */
async function migrateArrearsOnTermChange(oldTerm, newTerm, session) {
  console.log(`üîÑ Auto-creating payment records: ${oldTerm} ‚Üí ${newTerm}`);
  
  try {
    const encodedSession = session.replace(/\//g, '-');
    
    // Get all pupils
    const pupilsSnap = await db.collection('pupils').get();
    
    if (pupilsSnap.empty) {
      return { success: true, count: 0, totalArrears: 0 };
    }
    
    // Get all fee structures for current session
    const feeStructuresSnap = await db.collection('fee_structures')
      .where('session', '==', session)
      .get();
    
    const feeStructureMap = {};
    feeStructuresSnap.forEach(doc => {
      const data = doc.data();
      feeStructureMap[data.classId] = data.total || 0;
    });
    
    let createdCount = 0;
    let arrearsCount = 0;
    let totalArrearsAmount = 0;
    
    const batch = db.batch();
    let batchCount = 0;
    
    for (const pupilDoc of pupilsSnap.docs) {
      const pupilId = pupilDoc.id;
      const pupilData = pupilDoc.data();
      const classId = pupilData.class?.id;
      
      if (!classId) continue;
      
      const amountDue = feeStructureMap[classId] || 0;
      if (amountDue === 0) continue; // Skip if no fee structure
      
      // Check if payment record already exists for new term
      const newPaymentDocId = `${pupilId}_${encodedSession}_${newTerm}`;
      const existingPayment = await db.collection('payments').doc(newPaymentDocId).get();
      
      if (existingPayment.exists) {
        console.log(`‚è≠Ô∏è Skipping ${pupilData.name} - record exists`);
        continue;
      }
      
      // Get old term payment to calculate arrears
      const oldPaymentDocId = `${pupilId}_${encodedSession}_${oldTerm}`;
      const oldPaymentDoc = await db.collection('payments').doc(oldPaymentDocId).get();
      
      let arrears = 0;
      
      if (oldPaymentDoc.exists) {
        const oldData = oldPaymentDoc.data();
        arrears = Number(oldData.balance) || 0;
        
        if (arrears > 0) {
          arrearsCount++;
          totalArrearsAmount += arrears;
        }
      }
      
      // Create payment record for new term
      const newPaymentRef = db.collection('payments').doc(newPaymentDocId);
      
      batch.set(newPaymentRef, {
        pupilId: pupilId,
        pupilName: pupilData.name || 'Unknown',
        classId: classId,
        className: pupilData.class?.name || 'Unknown',
        session: session,
        term: newTerm,
        amountDue: amountDue,
        arrears: arrears,
        totalDue: amountDue + arrears,
        totalPaid: 0,
        balance: amountDue + arrears,
        status: arrears > 0 ? 'owing_with_arrears' : 'owing',
        lastPaymentDate: null,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
        migratedFrom: oldTerm,
        autoCreated: true
      });
      
      createdCount++;
      batchCount++;
      
      // Commit in batches of 400
      if (batchCount >= 400) {
        await batch.commit();
        batchCount = 0;
        console.log(`Progress: ${createdCount} records created...`);
      }
    }
    
    // Commit remaining
    if (batchCount > 0) {
      await batch.commit();
    }
    
    console.log(`‚úÖ Auto-created ${createdCount} payment records for ${newTerm}`);
    console.log(`   - ${arrearsCount} pupils have arrears`);
    console.log(`   - Total arrears: ‚Ç¶${totalArrearsAmount.toLocaleString()}`);
    
    return {
      success: true,
      count: createdCount,
      arrearsCount: arrearsCount,
      totalArrears: totalArrearsAmount
    };
    
  } catch (error) {
    console.error('‚ùå Term change migration failed:', error);
    throw error;
  }
}

/* =====================================================
   FIX 3: ENSURE PAYMENT RECORDS ALWAYS EXIST
===================================================== */

/**
 * ADD this function to admin.js
 * Call this when generating missing payment records
 */
async function ensureAllPupilsHavePaymentRecords() {
  const btn = document.getElementById('bulk-generate-btn');
  
  if (!confirm(
    'Generate/verify payment records for all pupils?\n\n' +
    'This will:\n' +
    '‚Ä¢ Create records for pupils who don\'t have them\n' +
    '‚Ä¢ Preserve all existing payment data\n' +
    '‚Ä¢ Calculate and apply arrears correctly\n\n' +
    'Continue?'
  )) {
    return;
  }
  
  if (btn) {
    btn.disabled = true;
    btn.innerHTML = '<span class="btn-loading">Generating records...</span>';
  }
  
  try {
    const settings = await window.getCurrentSettings();
    const session = settings.session;
    const term = settings.term;
    const encodedSession = session.replace(/\//g, '-');
    
    // Get all pupils
    const pupilsSnap = await db.collection('pupils').get();
    
    if (pupilsSnap.empty) {
      window.showToast?.('No pupils found', 'info');
      return;
    }
    
    // Get all fee structures
    const feeStructuresSnap = await db.collection('fee_structures')
      .where('session', '==', session)
      .get();
    
    const feeStructureMap = {};
    feeStructuresSnap.forEach(doc => {
      const data = doc.data();
      feeStructureMap[data.classId] = data.total || 0;
    });
    
    let totalCreated = 0;
    let totalSkipped = 0;
    let totalArrears = 0;
    
    const batch = db.batch();
    let batchCount = 0;
    
    for (const pupilDoc of pupilsSnap.docs) {
      const pupilId = pupilDoc.id;
      const pupilData = pupilDoc.data();
      const classId = pupilData.class?.id;
      
      if (!classId) continue;
      
      const amountDue = feeStructureMap[classId];
      if (!amountDue) {
        console.log(`‚è≠Ô∏è No fee structure for class ${pupilData.class?.name}`);
        continue;
      }
      
      const paymentDocId = `${pupilId}_${encodedSession}_${term}`;
      const existingPayment = await db.collection('payments').doc(paymentDocId).get();
      
      if (existingPayment.exists) {
        totalSkipped++;
        continue;
      }
      
      // Calculate arrears from previous session
      const previousSession = getPreviousSessionName(session);
      let arrears = 0;
      
      if (previousSession) {
        arrears = await calculateSessionBalance(pupilId, previousSession);
      }
      
      if (arrears > 0) {
        totalArrears += arrears;
      }
      
      // Create payment record
      const paymentRef = db.collection('payments').doc(paymentDocId);
      
      batch.set(paymentRef, {
        pupilId: pupilId,
        pupilName: pupilData.name || 'Unknown',
        classId: classId,
        className: pupilData.class?.name || 'Unknown',
        session: session,
        term: term,
        amountDue: amountDue,
        arrears: arrears,
        totalDue: amountDue + arrears,
        totalPaid: 0,
        balance: amountDue + arrears,
        status: arrears > 0 ? 'owing_with_arrears' : 'owing',
        lastPaymentDate: null,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
        autoCreated: true
      });
      
      totalCreated++;
      batchCount++;
      
      if (batchCount >= 400) {
        await batch.commit();
        batchCount = 0;
      }
    }
    
    if (batchCount > 0) {
      await batch.commit();
    }
    
    window.showToast?.(
      `‚úÖ Payment records verified!\n\n` +
      `Created: ${totalCreated} new records\n` +
      `Skipped: ${totalSkipped} (already exist)\n` +
      `Total arrears: ‚Ç¶${totalArrears.toLocaleString()}`,
      'success',
      10000
    );
    
    // Reload reports
    await loadOutstandingFeesReport();
    await loadFinancialReports();
    
  } catch (error) {
    console.error('Error generating payment records:', error);
    window.handleError?.(error, 'Failed to generate payment records');
  } finally {
    if (btn) {
      btn.disabled = false;
      btn.innerHTML = 'üìã Generate All Missing Payment Records';
    }
  }
}

// Make functions globally available
window.editFeeStructure = editFeeStructure;
window.saveFeeStructure = saveFeeStructure;
window.loadFeeStructures = loadFeeStructures;
window.migrateArrearsOnTermChange = migrateArrearsOnTermChange;
window.ensureAllPupilsHavePaymentRecords = ensureAllPupilsHavePaymentRecords;

console.log('‚úÖ Complete fee management fixes loaded');