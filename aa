/**
 * FEE STRUCTURE CREATION FIX
 * Prevents duplicate classes when recreating fee structures
 * 
 * Replace the saveFeeStructure() function in admin.js with this version
 */

async function saveFeeStructure() {
  const classSelect = document.getElementById('fee-config-class');
  const classId = classSelect?.value;
  const className = classSelect?.selectedOptions[0]?.dataset.className;
  
  if (!classId) {
    window.showToast?.('Please select a class', 'warning');
    return;
  }
  
  const tuition = parseFloat(document.getElementById('fee-tuition')?.value) || 0;
  const examFee = parseFloat(document.getElementById('fee-exam')?.value) || 0;
  const uniform = parseFloat(document.getElementById('fee-uniform')?.value) || 0;
  const books = parseFloat(document.getElementById('fee-books')?.value) || 0;
  const pta = parseFloat(document.getElementById('fee-pta')?.value) || 0;
  const other = parseFloat(document.getElementById('fee-other')?.value) || 0;
  
  const feeBreakdown = {
    tuition, exam_fee: examFee, uniform, books, pta, other
  };
  
  const total = Object.values(feeBreakdown).reduce((sum, val) => sum + val, 0);
  
  if (total <= 0) {
    window.showToast?.('Please enter at least one fee amount', 'warning');
    return;
  }
  
  const saveBtn = document.getElementById('save-fee-structure-btn');
  const isEditing = saveBtn?.dataset.editingId;
  
  if (saveBtn) {
    saveBtn.disabled = true;
    saveBtn.innerHTML = '<span class="btn-loading">Saving...</span>';
  }
  
  try {
    // ‚úÖ CRITICAL FIX: Use class-based ID only (permanent)
    const feeDocId = `fee_${classId}`;
    
    console.log(`Checking for existing fee structure: ${feeDocId}`);
    
    // Check if fee structure already exists
    const existingFeeDoc = await db.collection('fee_structures').doc(feeDocId).get();
    
    if (existingFeeDoc.exists && !isEditing) {
      const existingData = existingFeeDoc.data();
      const existingTotal = existingData.total || 0;
      
      // ‚úÖ FIX: Show clear update vs. create message
      const confirmation = confirm(
        `‚ö†Ô∏è FEE STRUCTURE ALREADY EXISTS\n\n` +
        `Class: ${className}\n\n` +
        `Current fee: ‚Ç¶${existingTotal.toLocaleString()} per term\n` +
        `New fee: ‚Ç¶${total.toLocaleString()} per term\n\n` +
        `This will UPDATE the existing fee structure (not create a duplicate).\n\n` +
        `Continue?`
      );
      
      if (!confirmation) {
        window.showToast?.('Operation cancelled', 'info');
        return;
      }
      
      console.log('User confirmed update of existing fee structure');
    }
    
    // Archive old version if updating
    if (isEditing || existingFeeDoc.exists) {
      const oldDoc = await db.collection('fee_structures').doc(feeDocId).get();
      if (oldDoc.exists) {
        await db.collection('fee_structure_history').add({
          ...oldDoc.data(),
          archivedAt: firebase.firestore.FieldValue.serverTimestamp(),
          archivedBy: auth.currentUser.uid,
          reason: isEditing ? 'Fee structure edited' : 'Fee structure recreated'
        });
        console.log('‚úì Old fee structure archived');
      }
    }
    
    // ‚úÖ CRITICAL FIX: Save WITHOUT session field (permanent)
    const createdAt = existingFeeDoc.exists 
      ? existingFeeDoc.data()?.createdAt || firebase.firestore.FieldValue.serverTimestamp()
      : firebase.firestore.FieldValue.serverTimestamp();
    
    await db.collection('fee_structures').doc(feeDocId).set({
      classId,
      className,
      fees: feeBreakdown,
      total: total,
      // NO SESSION FIELD - applies to all sessions
      createdAt: createdAt,
      updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
      lastModifiedBy: auth.currentUser.uid
    });

    const action = existingFeeDoc.exists ? 'updated' : 'created';
    
    window.showToast?.(
      `‚úì Fee structure ${action} for ${className}!\n\n` +
      `Per-term fee: ‚Ç¶${total.toLocaleString()}\n\n` +
      `This fee applies to ALL terms and sessions until you change it.`,
      'success',
      8000
    );
    
    console.log(`‚úì Fee structure ${action}: ${feeDocId}`);
    
    // Clear form
    document.getElementById('fee-config-class').value = '';
    ['fee-tuition', 'fee-exam', 'fee-uniform', 'fee-books', 'fee-pta', 'fee-other'].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.value = '';
    });
    
    // Reset button
    if (saveBtn) {
      saveBtn.textContent = 'üíæ Save Fee Structure';
      delete saveBtn.dataset.editingId;
    }
    
    await loadFeeStructures();
    
  } catch (error) {
    console.error('‚ùå Error saving fee structure:', error);
    window.showToast?.('Failed to save fee structure: ' + error.message, 'danger');
  } finally {
    if (saveBtn) {
      saveBtn.disabled = false;
      saveBtn.innerHTML = isEditing ? '‚úèÔ∏è Update Fee Structure' : 'üíæ Save Fee Structure';
    }
  }
}

/**
 * ‚úÖ FIXED: Load Fee Structures (shows class-based, permanent fees)
 */
async function loadFeeStructures() {
  const container = document.getElementById('fee-structures-list');
  if (!container) return;
  
  container.innerHTML = '<div style="text-align:center; padding:var(--space-lg);"><div class="spinner"></div><p>Loading fee structures...</p></div>';
  
  try {
    // ‚úÖ FIX: Query ALL fee structures (no session filter)
    const snapshot = await db.collection('fee_structures').get();
    
    console.log(`Found ${snapshot.size} fee structures`);
    
    if (snapshot.empty) {
      container.innerHTML = `
        <div style="text-align:center; padding:var(--space-2xl); color:var(--color-gray-600);">
          <p style="font-size:var(--text-lg); margin-bottom:var(--space-md);">üìã No Fee Structures Configured Yet</p>
          <p style="font-size:var(--text-sm);">Configure fees for your classes using the form above.</p>
        </div>
      `;
      return;
    }
    
    // ‚úÖ CRITICAL FIX: Check for duplicates by classId
    const feesByClass = new Map();
    
    snapshot.forEach(doc => {
      const data = doc.data();
      const classId = data.classId;
      
      if (!feesByClass.has(classId)) {
        feesByClass.set(classId, []);
      }
      
      feesByClass.get(classId).push({
        id: doc.id,
        ...data
      });
    });
    
    // Log duplicates
    feesByClass.forEach((fees, classId) => {
      if (fees.length > 1) {
        console.warn(`‚ö†Ô∏è DUPLICATE DETECTED: ${fees.length} fee structures for class ${classId}`);
        console.warn('   IDs:', fees.map(f => f.id));
      }
    });
    
    container.innerHTML = '';
    
    // Render each unique class (show most recent if duplicates exist)
    feesByClass.forEach((fees, classId) => {
      // If duplicates exist, use the most recently updated
      const feeToShow = fees.length > 1
        ? fees.reduce((latest, current) => {
            const latestTime = latest.updatedAt?.toMillis() || 0;
            const currentTime = current.updatedAt?.toMillis() || 0;
            return currentTime > latestTime ? current : latest;
          })
        : fees[0];
      
      const data = feeToShow;
      
      const feeItems = Object.entries(data.fees || {})
        .map(([key, value]) => `
          <div style="display:flex; justify-content:space-between; padding:var(--space-xs) 0;">
            <span style="text-transform:capitalize;">${key.replace(/_/g, ' ')}:</span>
            <strong>‚Ç¶${parseFloat(value).toLocaleString()}</strong>
          </div>
        `).join('');
      
      const card = document.createElement('div');
      card.className = 'fee-structure-card';
      card.style.cssText = `
        background: white;
        border: 1px solid var(--color-gray-300);
        border-radius: var(--radius-md);
        padding: var(--space-lg);
        margin-bottom: var(--space-md);
        ${fees.length > 1 ? 'border-left: 4px solid #ff9800;' : ''}
      `;
      
      // ‚úÖ FIX: Show as permanent (not session-specific)
      card.innerHTML = `
        ${fees.length > 1 ? `
          <div style="background: #fff3cd; border: 1px solid #ff9800; border-radius: var(--radius-sm); padding: var(--space-sm); margin-bottom: var(--space-md); font-size: var(--text-sm);">
            ‚ö†Ô∏è <strong>Note:</strong> ${fees.length} duplicate fee records exist for this class. Showing most recent. 
            <button class="btn-small btn-secondary" onclick="fixDuplicateFees('${classId}')" style="margin-left: var(--space-sm);">
              Fix Duplicates
            </button>
          </div>
        ` : ''}
        
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:var(--space-md); padding-bottom:var(--space-md); border-bottom:1px solid var(--color-gray-200);">
          <div>
            <h3 style="margin:0; color:var(--color-primary);">${data.className}</h3>
            <p style="margin:var(--space-xs) 0 0; font-size:var(--text-sm); color:var(--color-gray-600);">
              <strong>Applies to ALL Terms & Sessions</strong>
            </p>
          </div>
          <div style="display:flex; gap:var(--space-sm);">
            <button class="btn-small btn-primary" onclick="editFeeStructure('${data.id}')">
              ‚úèÔ∏è Edit
            </button>
            <button class="btn-small btn-danger" onclick="deleteFeeStructure('${data.id}', '${data.className}')">
              Delete
            </button>
          </div>
        </div>
        
        <div style="margin-bottom:var(--space-md);">
          ${feeItems}
        </div>
        
        <div style="padding-top:var(--space-md); border-top:2px solid var(--color-primary); display:flex; justify-content:space-between; align-items:center;">
          <strong style="font-size:var(--text-lg);">Total per term:</strong>
          <strong style="font-size:var(--text-xl); color:var(--color-primary);">‚Ç¶${parseFloat(data.total).toLocaleString()}</strong>
        </div>
        
        <div style="margin-top:var(--space-md); padding:var(--space-sm); background:#e3f2fd; border-left:4px solid #2196F3; border-radius:var(--radius-sm); font-size:var(--text-sm);">
          ‚ÑπÔ∏è This fee structure is <strong>permanent</strong> and applies to all terms and sessions until you edit or delete it.
        </div>
      `;
      
      container.appendChild(card);
    });
    
    console.log(`‚úì Displayed ${feesByClass.size} unique fee structures`);
    
  } catch (error) {
    console.error('‚ùå Error loading fee structures:', error);
    container.innerHTML = '<p style="text-align:center; color:var(--color-danger);">Error loading fee structures</p>';
  }
}

/**
 * ‚úÖ NEW: Fix duplicate fee structures
 */
async function fixDuplicateFees(classId) {
  if (!confirm(
    `Fix Duplicate Fee Structures?\n\n` +
    `This will:\n` +
    `‚Ä¢ Keep the most recent fee structure\n` +
    `‚Ä¢ Archive all older duplicates\n` +
    `‚Ä¢ Clean up the database\n\n` +
    `Continue?`
  )) {
    return;
  }
  
  try {
    // Get all fee structures for this class
    const snapshot = await db.collection('fee_structures')
      .where('classId', '==', classId)
      .get();
    
    if (snapshot.size <= 1) {
      window.showToast?.('No duplicates found', 'info');
      return;
    }
    
    const fees = [];
    snapshot.forEach(doc => {
      fees.push({ id: doc.id, ...doc.data() });
    });
    
    // Find most recent
    const mostRecent = fees.reduce((latest, current) => {
      const latestTime = latest.updatedAt?.toMillis() || latest.createdAt?.toMillis() || 0;
      const currentTime = current.updatedAt?.toMillis() || current.createdAt?.toMillis() || 0;
      return currentTime > latestTime ? current : latest;
    });
    
    console.log(`Most recent fee structure: ${mostRecent.id}`);
    
    // Archive and delete duplicates
    const batch = db.batch();
    let deleted = 0;
    
    for (const fee of fees) {
      if (fee.id !== mostRecent.id) {
        // Archive
        const archiveRef = db.collection('fee_structure_history').doc();
        batch.set(archiveRef, {
          ...fee,
          archivedAt: firebase.firestore.FieldValue.serverTimestamp(),
          archivedBy: auth.currentUser.uid,
          reason: 'Duplicate cleanup - keeping most recent'
        });
        
        // Delete
        batch.delete(db.collection('fee_structures').doc(fee.id));
        deleted++;
      }
    }
    
    await batch.commit();
    
    window.showToast?.(
      `‚úì Cleaned up ${deleted} duplicate(s)\n\nKept most recent fee structure.`,
      'success',
      5000
    );
    
    await loadFeeStructures();
    
  } catch (error) {
    console.error('Error fixing duplicates:', error);
    window.handleError?.(error, 'Failed to fix duplicates');
  }
}

// Make functions globally available
window.saveFeeStructure = saveFeeStructure;
window.loadFeeStructures = loadFeeStructures;
window.fixDuplicateFees = fixDuplicateFees;

console.log('‚úÖ Fee structure duplicate prevention fix loaded');